<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:int-http="http://www.springframework.org/schema/integration/http"
       xsi:schemaLocation="
       	http://www.springframework.org/schema/beans
		http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/integration
        http://www.springframework.org/schema/integration/spring-integration.xsd
        http://www.springframework.org/schema/integration/http
        http://www.springframework.org/schema/integration/http/spring-integration-http.xsd">

    <int:annotation-config/>

    <!-- Misc Channels -->
    <int:logging-channel-adapter id="loggingChannel" level="DEBUG" expression="payload"/>
    <int:wire-tap channel="loggingChannel"/>

    <!--Event-->
    <int:publish-subscribe-channel id="eventChannel"/>
    <int:publish-subscribe-channel id="pricingEventChannel"/>
    <int:publish-subscribe-channel id="orderEventChannel"/>
    <int:publish-subscribe-channel id="tradeEventChannel"/>

    <int-http:inbound-channel-adapter id="eventInboundAdapter"
                                      supported-methods="POST"
                                      path="/event"
                                      channel="eventChannel"/>

    <int:header-value-router id="eventRouter"
                             input-channel="eventChannel"
                             header-name="event-type">
        <int:mapping value="pricing" channel="pricingEventChannel"/>
        <int:mapping value="order" channel="orderEventChannel"/>
        <int:mapping value="trade" channel="tradeEventChannel"/>
    </int:header-value-router>

    <int-http:outbound-channel-adapter id="pricingEventOutboundAdapter"
                                       channel="pricingEventChannel"
                                       http-method="POST"
                                       url="${opes.bot.host}/bot/"/>

    <int-http:outbound-channel-adapter id="pricingEventOutboundAdapter"
                                       channel="pricingEventChannel"
                                       http-method="POST"
                                       url="${opes.bot.host}/bot/"/>

    <!--Data Request-->
    <int:channel id="dataRequestChannel"/>
    <int:channel id="dataRequestDLChannel">
        <int:queue capacity="10"/>
    </int:channel>
    <int:channel id="dataResponseChannel"/>
    <int:channel id="pricingRequestChannel"/>
    <int:channel id="orderDetailsRequestChannel"/>
    <int:channel id="tradeDetailsRequestChannel"/>
    <int:channel id="transactionDetailsRequestChannel"/>
    <int:channel id="smaRequestChannel"/>
    <int:channel id="emaRequestChannel"/>

    <int-http:inbound-gateway id="dataRequestGateway"
                              supported-methods="POST"
                              path="/data"
                              request-channel="dataRequestChannel"
                              reply-channel="dataResponseChannel"
                              mapped-request-headers="Data-Type, User-Agent, Content-Type, Connection"/>

    <int:header-value-router id="dataRequestRouter"
                             input-channel="dataRequestChannel"
                             header-name="data-type">
        <int:mapping value="pricing" channel="pricingRequestChannel"/>
        <int:mapping value="order" channel="orderDetailsRequestChannel"/>
        <int:mapping value="trade" channel="tradeDetailsRequestChannel"/>
        <int:mapping value="transaction" channel="transactionDetailsRequestChannel"/>
        <int:mapping value="sma" channel="smaRequestChannel"/>
        <int:mapping value="ema" channel="emaRequestChannel"/>
    </int:header-value-router>

    <int-http:outbound-gateway id="pricingRequestGateway"
                               request-channel="pricingRequestChannel"
                               reply-channel="dataResponseChannel"
                               http-method="GET"
                               url="${opes.core.host}/pricing?instruments={instruments}%26since={since}"
                               mapped-request-headers="Data-Type, User-Agent, Content-Type, Connection"
                               expected-response-type="java.util.Map">
        <int-http:uri-variable name="instruments" expression="payload.instruments"/>
        <int-http:uri-variable name="since" expression="payload.since"/>
    </int-http:outbound-gateway>

    <int-http:outbound-gateway id="smaRequestGateway"
                               request-channel="smaRequestChannel"
                               reply-channel="dataResponseChannel"
                               http-method="POST"
                               url="${opes.bot.host}/bot/indicator/sma"
                               mapped-request-headers="Data-Type, User-Agent, Content-Type, Connection"
                               expected-response-type="java.util.Map"/>

    <int-http:outbound-gateway id="emaRequestGateway"
                               request-channel="emaRequestChannel"
                               reply-channel="dataResponseChannel"
                               http-method="POST"
                               url="${opes.bot.host}/bot/indicator/ema"
                               mapped-request-headers="Data-Type, User-Agent, Content-Type, Connection"
                               expected-response-type="java.util.Map"/>

    <!--Action-->
    <int:channel id="actionRequestChannel"/>
    <int:channel id="actionRequestDLChannel">
        <int:queue capacity="10"/>
    </int:channel>
    <int:channel id="actionResponseChannel"/>

    <int-http:inbound-gateway id="actionGateway"
                              supported-methods="POST"
                              path="/action"
                              request-channel="actionRequestChannel"
                              reply-channel="actionResponseChannel"
                              mapped-request-headers="Action-Type, User-Agent, Content-Type, Connection"/>

    <int:header-value-router id="actionRouter"
                             input-channel="actionRequestChannel"
                             header-name="action-type">
        <int:mapping value="createOrder" channel="createOrderChannel"/>
        <int:mapping value="cancelOrder" channel="cancelOrderChannel"/>
        <int:mapping value="closeTrade" channel="closeTradeChannel"/>
    </int:header-value-router>

</beans>